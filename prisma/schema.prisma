// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  userId                 Int            @id @default(autoincrement())
  fullName               String
  mobileNumber           String         @unique
  role                   String         // Staff, Parent
  childInAchariya        Boolean
  childName              String?
  grade                  String?        // e.g. "Grade 10"
  campusId               Int?           // Link to Campus
  bankAccountDetails     String?
  referralCode           String         @unique // Format ACH25-XXXX
  status                 String         @default("Active") // Active, Inactive
  confirmedReferralCount Int            @default(0)
  yearFeeBenefitPercent  Float          @default(0)
  longTermBenefitPercent Float          @default(0)
  lastActiveYear         Int?
  benefitStatus          String         @default("Active") // Active, Inactive
  isFiveStarMember       Boolean        @default(false) // If true, eligible for Long Term benefits
  assignedCampus         String?        // For Campus Head role assignment
  
  // Earnings & Context
  studentFee             Int            @default(60000)
  academicYear           String         @default("2025-2026")
  createdAt              DateTime       @default(now())
  profileImage           String?
  email                  String?
  address                String?
  
  referrals              ReferralLead[]
  students               Student[]
  settlements            Settlement[]
  supportTickets         SupportTicket[]
}

model Student {
  studentId              Int            @id @default(autoincrement())
  fullName               String
  parentId               Int
  parent                 User           @relation(fields: [parentId], references: [userId])
  campusId               Int
  campus                 Campus         @relation(fields: [campusId], references: [id])
  grade                  String
  section                String?
  rollNumber             String?
  academicYear           String         @default("2025-2026")
  status                 String         @default("Active") // Active, Inactive, Alumni
  
  // Fee context for this specific student
  baseFee                Int            @default(60000)
  discountPercent        Float          @default(0)
  
  referralLeadId         Int?           @unique
  referralLead           ReferralLead?  @relation(fields: [referralLeadId], references: [leadId])
  
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
}

model ReferralLead {
  leadId         Int       @id @default(autoincrement())
  userId         Int
  user           User      @relation(fields: [userId], references: [userId])
  parentName     String
  parentMobile   String
  campusId       Int?      // Link to Campus
  campus         String?   // Legacy/Display name
  gradeInterested String?
  admittedYear   String?
  leadStatus     String    @default("New") // New, Follow-up, Confirmed
  confirmedDate  DateTime?
  createdAt      DateTime  @default(now())
  
  student        Student?
}

model BenefitSlab {
  slabId                 Int @id @default(autoincrement())
  tierName               String?   // e.g. "1 Star", "5 Stars"
  referralCount          Int @unique
  yearFeeBenefitPercent  Float
  longTermExtraPercent   Float
  baseLongTermPercent    Float @default(15)
  description            String?
}

model Admin {
  adminId        Int      @id @default(autoincrement())
  adminName      String
  adminMobile    String   @unique
  role           String   // Super Admin, Admission Admin, CampusHead
  assignedCampus String?  // For Campus Head role assignment
  status         String   @default("Active") // Active or Inactive
  createdAt      DateTime @default(now())
  profileImage   String?
  email          String?
  address        String?
}

model SystemSettings {
  id                    Int      @id @default(autoincrement())
  allowNewRegistrations Boolean  @default(true)
  currentAcademicYear   String   @default("2025-2026")
  defaultStudentFee     Int      @default(60000)
  maintenanceMode       Boolean  @default(false)
  
  // Dashboard Control
  staffReferralText     String?  @default("Hello ðŸ‘‹ Iâ€™m part of Achariyaâ€™s 5-Star Ambassador Program (25th Year Celebration). I recommend you to explore admission for your child. Click here: ${referralLink} â€“ Achariya Ambassador")
  parentReferralText    String?  @default("Hello ðŸ‘‹ Iâ€™m part of Achariyaâ€™s 5-Star Ambassador Program (25th Year Celebration). I recommend you to explore admission for your child. Click here: ${referralLink} â€“ Achariya Ambassador")
  staffWelcomeMessage   String?  @default("Welcome to the Staff Ambassador Dashboard")
  parentWelcomeMessage  String?  @default("Welcome to the Parent Ambassador Dashboard")
  
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // Admin who last changed it
}

model LeadManagementSettings {
  id                        Int      @id @default(autoincrement())
  autoAssignLeads           Boolean  @default(true)
  leadStaleDays             Int      @default(30)
  followupEscalationDays    Int      @default(7)
  duplicateDetectionEnabled Boolean  @default(true)
  updatedAt                 DateTime @updatedAt
  updatedBy                 String?
}

model SecuritySettings {
  id                    Int      @id @default(autoincrement())
  sessionTimeoutMinutes Int      @default(30)
  maxLoginAttempts      Int      @default(5)
  passwordResetExpiryHours Int    @default(24)
  twoFactorAuthEnabled  Boolean  @default(false)
  updatedAt             DateTime @updatedAt
  updatedBy             String?
}

model DataRetentionSettings {
  id                        Int      @id @default(autoincrement())
  keepInactiveDataMonths    Int      @default(12)
  archiveLeadsAfterDays     Int      @default(365)
  backupFrequencyDays       Int      @default(7)
  updatedAt                 DateTime @updatedAt
  updatedBy                 String?
}

model RolePermissions {
  id                    Int      @id @default(autoincrement())
  role                  String   @unique // Super Admin, CampusHead, Admission Admin, Campus Admin
  analyticsAccess       Boolean  @default(true)
  analyticsScope        String   @default("all") // all, campus, view-only, none
  userMgmtAccess        Boolean  @default(true)
  userMgmtScope         String   @default("all")
  userMgmtCreate        Boolean  @default(false)
  userMgmtEdit          Boolean  @default(false)
  userMgmtDelete        Boolean  @default(false)
  studentMgmtAccess     Boolean  @default(true)
  studentMgmtScope      String   @default("all")
  adminMgmtAccess       Boolean  @default(false)
  adminMgmtScope        String   @default("none")
  adminMgmtCreate       Boolean  @default(false)
  adminMgmtEdit         Boolean  @default(false)
  adminMgmtDelete       Boolean  @default(false)
  campusPerfAccess      Boolean  @default(true)
  campusPerfScope       String   @default("all")
  reportsAccess         Boolean  @default(true)
  reportsScope          String   @default("all")
  settlementsAccess     Boolean  @default(false)
  settlementsScope      String   @default("none")
  marketingKitAccess    Boolean  @default(false)
  marketingKitScope     String   @default("none")
  auditLogAccess        Boolean  @default(false)
  auditLogScope         String   @default("none")
  supportDeskAccess     Boolean  @default(false)
  supportDeskScope      String   @default("none")
  
  // Ambassador Portal Modules
  referralSubmissionAccess Boolean @default(true)
  referralSubmissionScope  String  @default("self")
  referralTrackingAccess   Boolean @default(true)
  referralTrackingScope    String  @default("self")
  savingsCalculatorAccess  Boolean @default(true)
  savingsCalculatorScope   String  @default("self")
  rulesAccessAccess        Boolean @default(true)
  rulesAccessScope         String  @default("all")

  settingsAccess        Boolean  @default(false)
  settingsScope         String   @default("none")
  updatedAt             DateTime @updatedAt
  updatedBy             String?  // Admin who last changed it
}

model Settlement {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [userId])
  amount          Float
  status          String   @default("Pending") // Pending, Processed, Rejected
  paymentMethod   String?  // e.g. "Bank Transfer"
  bankReference   String?
  payoutDate      DateTime?
  processedBy     Int?     // Admin ID
  remarks         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Resource {
  id              Int      @id @default(autoincrement())
  title           String
  description     String?
  type            String   // Image, Video, PDF, Template
  category        String   // Branding, WhatsApp, Facebook, General
  fileUrl         String
  thumbnailUrl    String?
  isActive        Boolean  @default(true)
  uploadedBy      Int      // Admin ID
  createdAt       DateTime @default(now())
}

model ActivityLog {
  id              Int      @id @default(autoincrement())
  adminId         Int?     // For Admin actions
  userId          Int?     // For User actions
  action          String   // e.g. "UPDATE_FEE", "DELETE_STUDENT", "LOGIN"
  module          String   // e.g. "studentMgmt", "settings"
  targetId        String?  // The ID of the affected resource
  description     String
  ipAddress       String?
  userAgent       String?
  createdAt       DateTime @default(now())
}

model SupportTicket {
  id              Int      @id @default(autoincrement())
  userId          Int
  user            User     @relation(fields: [userId], references: [userId])
  subject         String
  category        String   // Referral, Benefit, Technical, Other
  priority        String   @default("Medium") // Low, Medium, High, Urgent
  status          String   @default("Open") // Open, In-Progress, Resolved, Closed
  assignedAdminId Int?     // Admin ID
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  messages        TicketMessage[]
}

model TicketMessage {
  id              Int      @id @default(autoincrement())
  ticketId        Int
  ticket          SupportTicket @relation(fields: [ticketId], references: [id])
  senderId        Int      // UserID or AdminID
  senderType      String   // User, Admin
  message         String
  isInternal      Boolean  @default(false) // If true, only admins can see it
  createdAt       DateTime @default(now())
}

model Campus {
  id                    Int      @id @default(autoincrement())
  campusName            String   @unique // e.g. "ASM-VILLIANUR(9-12)"
  campusCode            String   @unique // e.g. "VILL-912"
  location              String   // City/Area
  grades                String   // e.g. "9-12" or "K-12"
  maxCapacity           Int      @default(500)
  currentEnrollment     Int      @default(0)
  isActive              Boolean  @default(true)
  campusHeadId          Int?     // Link to Admin.adminId
  contactEmail          String?
  contactPhone          String?
  address               String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Grade-specific fees
  gradeFees             GradeFee[]
  students              Student[]
}

model GradeFee {
  id        Int    @id @default(autoincrement())
  grade     String // e.g. "Pre-KG", "Grade 1", "Grade 12"
  annualFee Int    // The base fee for this grade at this campus
  campusId  Int
  campus    Campus @relation(fields: [campusId], references: [id], onDelete: Cascade)

  @@unique([campusId, grade])
}

model NotificationSettings {
  id                    Int      @id @default(autoincrement())
  emailNotifications    Boolean  @default(true)
  smsNotifications      Boolean  @default(false)
  whatsappNotifications Boolean  @default(true)
  leadFollowupReminders Boolean  @default(true)
  reminderFrequencyDays Int      @default(3)
  notifySuperAdminOnNewAdmins Boolean @default(true)
  notifyCampusHeadOnNewLeads  Boolean @default(true)
  updatedAt             DateTime @updatedAt
  updatedBy             String?
}
