generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = "postgresql://neondb_owner:npg_yA8r7RhbwpMH@ep-calm-surf-a1lz48ro-pooler.ap-southeast-1.aws.neon.tech/neondb?sslmode=require"
}

model User {
  userId                 Int             @id @default(autoincrement())
  fullName               String
  mobileNumber           String          @unique
  role                   String
  childInAchariya        Boolean
  childName              String?
  grade                  String?
  campusId               Int?
  bankAccountDetails     String?
  referralCode           String          @unique
  status                 String          @default("Active")
  confirmedReferralCount Int             @default(0)
  yearFeeBenefitPercent  Float           @default(0)
  longTermBenefitPercent Float           @default(0)
  lastActiveYear         Int?
  benefitStatus          String          @default("Active")
  isFiveStarMember       Boolean         @default(false)
  assignedCampus         String?
  studentFee             Int             @default(60000)
  academicYear           String          @default("2025-2026")
  createdAt              DateTime        @default(now())
  profileImage           String?
  email                  String?
  address                String?
  paymentAmount          Int             @default(0)
  paymentStatus          String          @default("Pending")
  transactionId          String?
  aadharNo               String?
  childEprNo             String?
  empId                  String?
  password               String?
  deletionRequestedAt    DateTime?
  notifications          Notification[]
  referrals              ReferralLead[]
  settlements            Settlement[]
  referredStudents       Student[]       @relation("StudentAmbassador")
  students               Student[]       @relation("StudentParent")
  supportTickets         SupportTicket[]
}

model Student {
  studentId       Int           @id @default(autoincrement())
  fullName        String
  parentId        Int
  campusId        Int
  grade           String
  section         String?
  rollNumber      String?
  academicYear    String        @default("2025-2026")
  status          String        @default("Active")
  baseFee         Int           @default(60000)
  discountPercent Float         @default(0)
  referralLeadId  Int?          @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  ambassadorId    Int?
  ambassador      User?         @relation("StudentAmbassador", fields: [ambassadorId], references: [userId])
  campus          Campus        @relation(fields: [campusId], references: [id])
  parent          User          @relation("StudentParent", fields: [parentId], references: [userId])
  referralLead    ReferralLead? @relation(fields: [referralLeadId], references: [leadId])

  @@index([parentId])
  @@index([campusId])
  @@index([ambassadorId])
}

model ReferralLead {
  leadId          Int       @id @default(autoincrement())
  userId          Int
  parentName      String
  parentMobile    String
  campusId        Int?
  campus          String?
  gradeInterested String?
  admittedYear    String?
  leadStatus      String    @default("New")
  confirmedDate   DateTime?
  createdAt       DateTime  @default(now())
  studentName     String?
  user            User      @relation(fields: [userId], references: [userId])
  student         Student?

  @@index([userId])
  @@index([campus])
  @@index([leadStatus])
}

model BenefitSlab {
  slabId                Int     @id @default(autoincrement())
  tierName              String?
  referralCount         Int     @unique
  yearFeeBenefitPercent Float
  longTermExtraPercent  Float
  baseLongTermPercent   Float   @default(15)
  description           String?
}

model Admin {
  adminId        Int            @id @default(autoincrement())
  adminName      String
  adminMobile    String         @unique
  role           String
  assignedCampus String?
  status         String         @default("Active")
  createdAt      DateTime       @default(now())
  profileImage   String?
  email          String?
  address        String?
  password       String?
  notifications  Notification[]

  @@index([role])
  @@index([assignedCampus])
}

model SystemSettings {
  id                    Int      @id @default(autoincrement())
  allowNewRegistrations Boolean  @default(true)
  currentAcademicYear   String   @default("2025-2026")
  defaultStudentFee     Int      @default(60000)
  maintenanceMode       Boolean  @default(false)
  staffReferralText     String?  @default("Hello ðŸ‘‹ Iâ€™m part of Achariyaâ€™s 5-Star Ambassador Program (25th Year Celebration). I recommend you to explore admission for your child. Click here: ${referralLink} â€“ Achariya Ambassador")
  parentReferralText    String?  @default("Hello ðŸ‘‹ Iâ€™m part of Achariyaâ€™s 5-Star Ambassador Program (25th Year Celebration). I recommend you to explore admission for your child. Click here: ${referralLink} â€“ Achariya Ambassador")
  staffWelcomeMessage   String?  @default("Welcome to the Staff Ambassador Dashboard")
  parentWelcomeMessage  String?  @default("Welcome to the Parent Ambassador Dashboard")
  alumniReferralText    String?  @default("Hello ðŸ‘‹ I'm part of Achariya's 5-Star Ambassador Program (25th Year Celebration). I recommend you to explore admission for your child. Click here: ${referralLink} â€“ Achariya Ambassador")
  alumniWelcomeMessage  String?  @default("Welcome to the Alumni Ambassador Dashboard")
  updatedAt             DateTime @updatedAt
  updatedBy             String?
}

model LeadManagementSettings {
  id                        Int      @id @default(autoincrement())
  autoAssignLeads           Boolean  @default(true)
  leadStaleDays             Int      @default(30)
  followupEscalationDays    Int      @default(7)
  duplicateDetectionEnabled Boolean  @default(true)
  updatedAt                 DateTime @updatedAt
  updatedBy                 String?
}

model SecuritySettings {
  id                       Int      @id @default(autoincrement())
  sessionTimeoutMinutes    Int      @default(30)
  maxLoginAttempts         Int      @default(5)
  passwordResetExpiryHours Int      @default(24)
  twoFactorAuthEnabled     Boolean  @default(false)
  updatedAt                DateTime @updatedAt
  updatedBy                String?
}

model DataRetentionSettings {
  id                     Int      @id @default(autoincrement())
  keepInactiveDataMonths Int      @default(12)
  archiveLeadsAfterDays  Int      @default(365)
  backupFrequencyDays    Int      @default(7)
  updatedAt              DateTime @updatedAt
  updatedBy              String?
}

model RolePermissions {
  id                       Int      @id @default(autoincrement())
  role                     String   @unique
  analyticsAccess          Boolean  @default(true)
  analyticsScope           String   @default("all")
  userMgmtAccess           Boolean  @default(true)
  userMgmtScope            String   @default("all")
  userMgmtCreate           Boolean  @default(false)
  userMgmtEdit             Boolean  @default(false)
  userMgmtDelete           Boolean  @default(false)
  studentMgmtAccess        Boolean  @default(true)
  studentMgmtScope         String   @default("all")
  adminMgmtAccess          Boolean  @default(false)
  adminMgmtScope           String   @default("none")
  adminMgmtCreate          Boolean  @default(false)
  adminMgmtEdit            Boolean  @default(false)
  adminMgmtDelete          Boolean  @default(false)
  campusPerfAccess         Boolean  @default(true)
  campusPerfScope          String   @default("all")
  reportsAccess            Boolean  @default(true)
  reportsScope             String   @default("all")
  settlementsAccess        Boolean  @default(false)
  settlementsScope         String   @default("none")
  marketingKitAccess       Boolean  @default(false)
  marketingKitScope        String   @default("none")
  auditLogAccess           Boolean  @default(false)
  auditLogScope            String   @default("none")
  supportDeskAccess        Boolean  @default(false)
  supportDeskScope         String   @default("none")
  referralSubmissionAccess Boolean  @default(true)
  referralSubmissionScope  String   @default("self")
  referralTrackingAccess   Boolean  @default(true)
  referralTrackingScope    String   @default("self")
  savingsCalculatorAccess  Boolean  @default(true)
  savingsCalculatorScope   String   @default("self")
  rulesAccessAccess        Boolean  @default(true)
  rulesAccessScope         String   @default("all")
  settingsAccess           Boolean  @default(false)
  settingsScope            String   @default("none")
  updatedAt                DateTime @updatedAt
  updatedBy                String?
  studentMgmtCreate        Boolean  @default(true)
  studentMgmtDelete        Boolean  @default(false)
  studentMgmtEdit          Boolean  @default(true)
  deletionHubAccess        Boolean  @default(false)
  deletionHubScope         String   @default("none")
  passwordResetAccess      Boolean  @default(false)
  passwordResetScope       String   @default("none")
}

model Settlement {
  id            Int       @id @default(autoincrement())
  userId        Int
  amount        Float
  status        String    @default("Pending")
  paymentMethod String?
  bankReference String?
  payoutDate    DateTime?
  processedBy   Int?
  remarks       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [userId])
}

model Resource {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?
  type         String
  category     String
  fileUrl      String
  thumbnailUrl String?
  isActive     Boolean  @default(true)
  uploadedBy   Int
  createdAt    DateTime @default(now())
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  adminId     Int?
  userId      Int?
  action      String
  module      String
  targetId    String?
  description String
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
}

model SupportTicket {
  id              Int             @id @default(autoincrement())
  userId          Int
  subject         String
  category        String
  priority        String          @default("Medium")
  status          String          @default("Open")
  assignedAdminId Int?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  campus          String?
  message         String
  resolvedAt      DateTime?
  escalationLevel Int             @default(1)
  lastEscalatedAt DateTime?
  user            User            @relation(fields: [userId], references: [userId])
  messages        TicketMessage[]
}

model TicketMessage {
  id         Int           @id @default(autoincrement())
  ticketId   Int
  senderId   Int
  senderType String
  message    String
  isInternal Boolean       @default(false)
  createdAt  DateTime      @default(now())
  ticket     SupportTicket @relation(fields: [ticketId], references: [id])
}

model Campus {
  id                Int            @id @default(autoincrement())
  campusName        String         @unique
  campusCode        String         @unique
  location          String
  grades            String
  maxCapacity       Int            @default(500)
  currentEnrollment Int            @default(0)
  isActive          Boolean        @default(true)
  campusHeadId      Int?
  contactEmail      String?
  contactPhone      String?
  address           String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  targets           CampusTarget[]
  gradeFees         GradeFee[]
  students          Student[]
}

model CampusTarget {
  id              Int      @id @default(autoincrement())
  campusId        Int
  month           Int
  year            Int
  leadTarget      Int      @default(0)
  admissionTarget Int      @default(0)
  updatedAt       DateTime @updatedAt
  campus          Campus   @relation(fields: [campusId], references: [id])

  @@unique([campusId, month, year])
  @@index([campusId])
}

model GradeFee {
  id        Int    @id @default(autoincrement())
  grade     String
  annualFee Int
  campusId  Int
  campus    Campus @relation(fields: [campusId], references: [id], onDelete: Cascade)

  @@unique([campusId, grade])
}

model NotificationSettings {
  id                          Int      @id @default(autoincrement())
  emailNotifications          Boolean  @default(true)
  smsNotifications            Boolean  @default(false)
  whatsappNotifications       Boolean  @default(true)
  leadFollowupReminders       Boolean  @default(true)
  reminderFrequencyDays       Int      @default(3)
  notifySuperAdminOnNewAdmins Boolean  @default(true)
  notifyCampusHeadOnNewLeads  Boolean  @default(true)
  updatedAt                   DateTime @updatedAt
  updatedBy                   String?
}

model MarketingAsset {
  id           Int      @id @default(autoincrement())
  name         String
  category     String
  description  String?
  fileUrl      String
  fileType     String?
  fileSize     Int?
  isActive     Boolean  @default(true)
  sortOrder    Int      @default(0)
  uploadedById Int?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model OtpVerification {
  id        Int      @id @default(autoincrement())
  mobile    String   @unique
  otp       String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int?
  adminId   Int?
  title     String
  message   String
  type      String
  link      String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  admin     Admin?   @relation(fields: [adminId], references: [adminId])
  user      User?    @relation(fields: [userId], references: [userId])
}
